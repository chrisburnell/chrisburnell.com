---
title: eleventy-cache-webmentions
photo:
  url: eleventy-cache-webmentions.png
  alt: A hand emblazoned with a tattoo reading, ‚ÄúCache up Sucker‚Äù with a dollar sign in the middle
emoji: üí¨
github: chrisburnell/eleventy-cache-webmentions
branch: main
npm: "@chrisburnell/eleventy-cache-webmentions"
license: MIT
tags:
  - eleventy
  - indieweb
  - javascript
  - nunjucks
  - package
syndicate_to:
  - https://mastodon.social/users/chrisburnell/statuses/107399910372983580
  - https://twitter.com/iamchrisburnell/status/1467811195981860867
toc: true
---

<figure>
	{% image './images/content/eleventy-cache-webmentions.png', 'A hand emblazoned with a tattoo reading, ‚ÄúCache up Sucker‚Äù with a dollar sign in the middle', 'pixelated' %}
</figure>

{% include 'package.njk' %}

## Quick Guide

I wrote a quicker and simpler guide to getting this Eleventy plugin working that cuts out all the fluff and extra details. You can read about it here: [Webmention Setup for Eleventy](/article/webmention-eleventy-setup/).

## Installation

{% include 'installation.njk' %}

Once installed there are **two** more **required** set-up steps:

### Add it to your config

Inside your Eleventy config file (typically `.eleventy.js`), use `addPlugin`:

```javascript
const pluginWebmentions = require("@chrisburnell/eleventy-cache-webmentions")

module.exports = function(eleventyConfig) {
	eleventyConfig.addPlugin(pluginWebmentions, {
		// these 3 fields are all required!
		domain: "https://example.com",
		feed: "https://webmentions.example.com?token=S3cr3tT0k3n",
		key: "children"
	})
}
```

## Options

<table>
    <thead>
        <tr>
            <th>option</th>
            <th>default value</th>
            <th>description</th>
            <th class="numeral">version added</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td><code>domain</code><br><em>required</em></td>
            <td>‚Äî</td>
            <td>The website you‚Äôre fetching Webmentions for.</td>
            <td class="numeral">0.0.1</td>
        </tr>
        <tr>
            <td><code>feed</code><br><em>required</em></td>
            <td>‚Äî</td>
            <td>The URL of your Webmention server‚Äôs feed for your <code>domain</code>.</td>
            <td class="numeral">0.2.0</td>
        </tr>
        <tr>
            <td><code>key</code><br><em>required</em></td>
            <td>‚Äî</td>
            <td>The key in the above <code>feed</code> whose value is an Array of Webmentions.</td>
            <td class="numeral">0.0.1</td>
        </tr>
        <tr>
            <td><code>directory</code></td>
            <td><code>".cache"</code></td>
            <td>See <a href="https://www.11ty.dev/docs/plugins/cache/#cache-directory">Eleventy Fetch‚Äôs Cache Directory</a> for more information.</td>
            <td class="numeral">1.1.2</td>
        </tr>
        <tr>
            <td><code>duration</code></td>
            <td><code>"1d"</code> <em>or</em> 1 day</td>
            <td>See <a href="https://www.11ty.dev/docs/plugins/cache/#change-the-cache-duration">Eleventy Fetch‚Äôs Cache Duration</a> for more information.</td>
            <td class="numeral">0.0.1</td>
        </tr>
        <tr>
            <td><code>uniqueKey</code></td>
            <td><code>"webmentions"</code></td>
            <td>The name of the file generated by Eleventy Fetch.</td>
            <td class="numeral">0.1.9</td>
        </tr>
        <tr>
            <td><code>allowedHTML</code></td>
            <td>See code example below</td>
            <td>See the <a href="https://www.npmjs.com/package/sanitize-html">sanitize-html</a> package for more information.</td>
            <td class="numeral">0.0.1</td>
        </tr>
        <tr>
            <td><code>allowlist</code></td>
            <td><code>[]</code></td>
            <td>An Array of root URLs from which Webmentions are kept.</td>
            <td class="numeral">1.1.0</td>
        </tr>
        <tr>
            <td><code>blocklist</code></td>
            <td><code>[]</code></td>
            <td>An Array of root URLs from which Webmentions are discarded.</td>
            <td class="numeral">1.1.0</td>
        </tr>
        <tr>
            <td><code>urlReplacements</code></td>
            <td><code>{}</code></td>
            <td>An Object of key-value string pairs containing from-to URL replacements on this <code>domain</code>.</td>
            <td class="numeral">0.0.3</td>
        </tr>
        <tr>
            <td><code>maximumHtmlLength</code></td>
            <td><code>2000</code></td>
            <td>Maximum number of characters in a Webmention‚Äôs HTML content, beyond which point a different message is shown, referring to the original source.</td>
            <td class="numeral">0.0.1</td>
        </tr>
        <tr>
            <td><code>maximumHtmlText</code></td>
            <td><code>"mentioned this in"</code></td>
            <td>The glue-y part of the message displayed when a Webmention content‚Äôs character count exceeds <code>maximumHtmlLength</code>.</td>
            <td class="numeral">0.1.0</td>
        </tr>
    </tbody>
</table>

Advanced control over how the Webmentions are cached and processed is done by passing `options` into the plugin when using `addPlugin`:

```javascript
const pluginWebmentions = require("@chrisburnell/eleventy-cache-webmentions")

module.exports = function(eleventyConfig) {
	eleventyConfig.addPlugin(pluginWebmentions, {
		domain: "https://example.com",
		feed: "https://webmentions.example.com?token=S3cr3tT0k3n",
		key: "children",
		directory: ".cache",
		duration: "1d",
		uniqueKey: "webmentions",
		allowedHTML: {
			allowedTags: ["b", "i", "em", "strong", "a"],
			allowedAttributes: {
				a: ["href"],
			},
		},
		allowlist: [],
		blocklist: [],
		urlReplacements: {},
		maximumHtmlLength: 2000,
		maximumHtmlText: "mentioned this in",
	})
}
```

## JavaScript Usage

Accessing the plugin in JavaScript in the way shown below will give you an Object containing your cached Webmentions organised in key:value pairs where the key is a URL on your domain and the value is an array of data for Webmentions sent to that URL.

```javascript
const Webmentions = require("@chrisburnell/eleventy-cache-webmentions")(null, {
	domain: "https://example.com",
	feed: "https://webmentions.example.com?token=S3cr3tT0k3n",
	key: "children"
})

const webmentionsByUrl = await Webmentions()
```

This can prove to be very useful when building out your pages. Using [Eleventy‚Äôs Data Cascade](https://www.11ty.dev/docs/data-cascade/), we can attach Webmentions to each page by using [Directory Specific Data Files](https://www.11ty.dev/docs/data-template-dir/):

```javascript
const Webmentions = require("@chrisburnell/eleventy-cache-webmentions")(null, {
	domain: "https://example.com",
	feed: "https://webmentions.example.com?token=S3cr3tT0k3n",
	key: "children"
})

module.exports = async () => {
	const webmentionsByUrl = await Webmentions()

	return {
		eleventyComputed: {
			webmentions: (data) => {
				const webmentionsForUrl = webmentionsByUrl["https://example.com" + data.page.url] || []

				if (webmentionsForUrl.length) {
					return webmentionsForUrl.sort((a, b) => {
						return (b.data.published || b.verified_date) - (a.data.published || a.verified_date)
					})
				}
				return []
			},
		},
	}
}
```

You can now use this data in a number of useful ways, not limited to things like creating a collection of pages ordered by number of Webmentions:

```javascript
module.exports = (eleventyConfig) => {
	eleventyConfig.addCollection("popular", (collection) => {
		return collection
			.sort((a, b) => {
				return b.data.webmentions.length - a.data.webmentions.length
			})
	})
}
```

## Liquid/Nunjucks Usage

Accessing the plugin in Liquid/Nunjucks by using a Filter and passing in a URL in the way shown below will give you an Array containing the cached Webmentions for the given URL.

{% raw %}
```twig
{% set responses = webmentions %}
```
{% endraw %}

**OR**

{% raw %}
```twig
{% set responses = page.url | getWebmentions %}
```
{% endraw %}

You can get back only specific [response post types](https://indieweb.org/responses#Response_Post_Types) by passing a second argument:

{% raw %}
```twig
{% set reactions = page.url | getWebmentions(['like-of', 'repost-of', 'bookmark-of']) %}
{% set replies = page.url | getWebmentions(['mention-of', 'in-reply-to']) %}
```
{% endraw %}

And, if you need it, the entire Object of sorted Webmentions is available too:

{% raw %}
```twig
{% set count = 0 %}
{% for url, array in webmentionsAll %}
	{% set count = array.length + count %}
{% endfor %}
<p>This site has received {{ count }} Webmentions!</p>
```
{% endraw %}

<h2 id="webmention-io">Webmention.io</h2>

[Webmention.io](https://webmention.io) is a in-place Webmention receiver solution that you can use by authenticating yourself via [IndieAuth](https://indieauth.com/) (or host it yourself), and, like so much other publically-available IndieWeb software, is built and hosted by [Aaron Parecki](https://aaronparecki.com/).

### Add your token

Get set up on [Webmention.io](https://webmention.io) and add your **API Key** (found on your [settings page](https://webmention.io/settings)) to your project as an environment variable, i.e. in a `.env` file in the root of your project:

```text
WEBMENTION_IO_TOKEN=njJql0lKXnotreal4x3Wmd
```

### Set your feed and key config options

```javascript
const pluginWebmentions = require("@chrisburnell/eleventy-cache-webmentions")

module.exports = function(eleventyConfig) {
	eleventyConfig.addPlugin(pluginWebmentions, {
		domain: "https://example.com",
		feed: `https://webmention.io/api/mentions.jf2?domain=example.com&per-page=9001&token=${process.env.WEBMENTION_IO_TOKEN}`,
		key: "children"
	})
}
```

## go-jamming

[go-jamming](https://git.brainbaking.com/wgroeneveld/go-jamming) is a self-hosted Webmention sender and receiver, built in Go by [Wouter Groeneveld](https://brainbaking.com) and available with more information on his [personal git instance](https://git.brainbaking.com/wgroeneveld/go-jamming).

### Add your token

Once you‚Äôve set up your *go-jamming* server and you‚Äôve defined your token, you‚Äôll need add it to your project as an environment variable, i.e. in a `.env` file in the root of your project:

```text
GO_JAMMING_TOKEN=njJql0lKXnotreal4x3Wmd
```

### Set your feed and key config options

```javascript
const pluginWebmentions = require("@chrisburnell/eleventy-cache-webmentions")

module.exports = function(eleventyConfig) {
	eleventyConfig.addPlugin(pluginWebmentions, {
		domain: "https://example.com",
		feed: `https://jam.example.com/webmention/example.com/${process.env.GO_JAMMING_TOKEN}`,
		key: "json"
	})
}
```
