---
title: eleventy-cache-webmentions
photo:
  url: eleventy-cache-webmentions.png
  alt: A hand emblazoned with a tattoo reading, ‚ÄúCache up Sucker‚Äù with a dollar sign in the middle
emoji: üí¨
github: chrisburnell/eleventy-cache-webmentions
branch: main
dev: true
npm: "@chrisburnell/eleventy-cache-webmentions"
license: MIT
tags:
  - eleventy
  - indieweb
  - javascript
  - nunjucks
  - package
syndicate_to:
  - https://mastodon.social/users/chrisburnell/statuses/107399910372983580
  - https://twitter.com/iamchrisburnell/status/1467811195981860867
  - https://fediverse.repc.co/@chrisburnell/111754580552087852
toc: true
---

<figure>
	{% image './images/content/eleventy-cache-webmentions.png', 'A hand with a tattoo reading, ‚ÄúCache up Sucker‚Äù with a dollar sign in the middle', 'pixelated' %}
</figure>

{% include 'package.njk' %}


<div class=" [ box  box--warning ] ">
<details class=" [ flow ] ">
<summary>Breaking changes for v2.0.0!</summary>

Version 2.0.0 introduces a breaking change for those migrating from earlier versions of the plugin. This affects usage of the plugin from JavaScript files; specifically, you will need to make a small change to the way that you `require()` the plugin by removing an extra set of parentheses:

**v1.2.5 and below**

```javascript
require("@chrisburnell/eleventy-cache-webmentions")()
```

**v2.0.0 and above**

```javascript
require("@chrisburnell/eleventy-cache-webmentions")
```

</details>
</div>

<div class=" [ box ] [ flow ] ">

## Quick Guide

I wrote a quicker and simpler guide to getting this Eleventy plugin working that cuts out all the fluff and extra details.

Check it out: [Webmention Setup for Eleventy](/article/webmention-eleventy-setup/).

</div>

## Installation

{% include 'installation.njk' %}

Inside your Eleventy config file, use `addPlugin()` to add it to your project:

```javascript
const pluginWebmentions = require("@chrisburnell/eleventy-cache-webmentions")

module.exports = function(eleventyConfig) {
	eleventyConfig.addPlugin(pluginWebmentions, {
		// These 3 fields are all required!
		domain: "https://example.com",
		feed: "https://webmentions.example.com?token=S3cr3tT0k3n",
		key: "array_of_webmentions"
	})
}
```

<div class=" [ box  box--warning ] [ flow ] ">
	<p>Make sure you get the correct values for this configuration. Check below for both <a href="#webmention-io">Webmention.io configuration</a> and <a href="#go-jamming">go-jamming configuration</a>.</p>
</div>

<c-details>
    <summary>Full options list</summary>

```javascript
const pluginWebmentions = require("@chrisburnell/eleventy-cache-webmentions")

module.exports = function(eleventyConfig) {
	eleventyConfig.addPlugin(pluginWebmentions, {
		// The website you‚Äôre fetching Webmentions for.
		domain: "https://example.com",

		// The URL of your Webmention server‚Äôs feed for your website.
		feed: "https://webmentions.example.com?token=S3cr3tT0k3n",

		// The key in your Webmention server‚Äôs feed that contains the array of
		// Webmentions.
		key: "array_of_webmentions",

		// Where the cached file containing your Webmentions is stored.
		// See: https://www.11ty.dev/docs/plugins/cache/#cache-directory
		directory: ".cache",

		// The length of time to wait between fetching fresh Webmentions.
		// See: https://www.11ty.dev/docs/plugins/cache/#change-the-cache-duration
		duration: "1d",

		// The name of the file generated by Eleventy Fetch.
		uniqueKey: "webmentions",

		// What HTML elements are allowed within Webmention content.
		// Elements/attributes not here are removed when getting the content of
		// a Webmention.
		// See: https://www.npmjs.com/package/sanitize-html
		allowedHTML: {
			allowedTags: ["b", "i", "em", "strong", "a"],
			allowedAttributes: {
				a: ["href"],
			},
		},

		// An Array of URLs from which Webmentions are exclusively kept.
		allowlist: [],

		// An Array of URLs from which Webmentions are discarded.
		blocklist: [],

		// An Object of key-value string pairs containing from-to URL
		// replacements on your website.
		urlReplacements: {},

		// Maximum number of characters in a Webmention‚Äôs HTML content, beyond
		// which point a different message is shown, referring to the original
		// source.
		maximumHtmlLength: 2000,

		// The glue-y part of the message displayed when a Webmention content‚Äôs
		// character count exceeds `maximumHtmlLength`.
		maximumHtmlText: "mentioned this in",
	})
}
```

</c-details>

## Usage

`eleventy-cache-webmentions` comes with a number of ways of accessing your Webmentions as [Global Data](https://www.11ty.dev/docs/data-global-custom/) in both JavaScript and Liquid/Nunjucks as well as a series of [Eleventy Filters](https://www.11ty.dev/docs/filters/) and JavaScript Functions for filtering, sorting, and reading properties about each Webmention:

### Global Data

<c-details>
    <summary>JavaScript</summary>

```javascript
const {
	defaults, // default options for the plugin
	webmentionsByUrl, // Object containing Arrays of Webmentions by URL
} = require("@chrisburnell/eleventy-cache-webmentions")
```

</c-details>

<c-details>
    <summary>Liquid / Nunjucks</summary>

{% raw %}
```twig
{# default options for the plugin #}
{{ webmentionsDefaults }}
{# Object containing Arrays of Webmentions by URL #}
{{ webmentionsByUrl }}
```
{% endraw %}

</c-details>

### Filters

<c-details>
    <summary>JavaScript</summary>

```javascript
const {
	getWebmentions, // get Array of Webmentions for a given URL
	getWebmentionsByTypes, // filter Webmentions by their response type
	getWebmentionPublished, // get received/published time of a Webmention
	getWebmentionContent, // get content of a Webmention
	getWebmentionSource, // get source URL of a Webmention (where it's from)
	getWebmentionTarget, // get target URL of a Webmention (where it's sent to)
	getWebmentionType, // get response type of a Webmention
} = require("@chrisburnell/eleventy-cache-webmentions")

// This is NOT the best way to get Webmentions!
// See "Attach Webmentions to Pages using Directory Data" below.
const webmentions = getWebmentions({
	domain: "https://example.com",
	feed: "https://webmentions.example.com?token=S3cr3tT0k3n",
	key: "array_of_webmentions"
}, "https://example.com/specific-page/")

const responsesOnly = getWebmentionsByTypes(webmentions, ['mention-of', 'in-reply-to'])

webmentions.forEach((webmention) => {
	const published = getWebmentionPublished(webmention)
	const content = getWebmentionContent(webmention)
	const source = getWebmentionSource(webmention)
	const target = getWebmentionTarget(webmention)
	const type = getWebmentionType(webmention)
})
```

</c-details>

<c-details>
    <summary>Liquid / Nunjucks</summary>

{% raw %}
```twig
{# get Array of Webmentions for a given URL #}
{% set webmentions = ('https://example.com' + page.url) | getWebmentions %}

{# filter Webmentions by their response type #}
{{ set responses = webmentions | getWebmentionsByTypes(['mention-of', 'in-reply-to']) }}

{% for webmention in webmentions %}
    {# get received/published time of a Webmention #}
    {{ webmentions | getWebmentionPublished }}
    {# get content of a Webmention #}
    {{ webmentions | getWebmentionContent }}
    {# get source URL of a Webmention (where it's from) #}
    {{ webmentions | getWebmentionSource }}
    {# get target URL of a Webmention (where it's sent to) #}
    {{ webmentions | getWebmentionTarget }}
    {# get response type of a Webmention #}
    {{ webmentions | getWebmentionType }}
{% endfor %}
```
{% endraw %}

</c-details>

<h2 id="attach-webmentions">Attach Webmentions to Pages using Directory Data</h2>

Using [Eleventy‚Äôs Data Cascade](https://www.11ty.dev/docs/data-cascade/), you can attach Webmentions to each page by using [Directory Specific Data Files](https://www.11ty.dev/docs/data-template-dir/).

For example, if you have a folder, `/pages/`, and want to attach Webmentions to each page, create or add the following to a `pages.11tydata.js` file within the folder:

```javascript
const { getWebmentions, getPublished } = require("@chrisburnell/eleventy-cache-webmentions")

module.exports = {
	eleventyComputed: {
		webmentions: (data) => {
			// Get this page's Webmentions as an Array (based on the URL)
			const webmentionsForUrl = getWebmentions({
				domain: "https://example.com",
				feed: "https://webmentions.example.com?token=S3cr3tT0k3n",
				key: "array_of_webmentions"
			}, "https://example.com" + data.page.url)

			// If there are Webmentions for this page
			if (webmentionsForUrl.length) {
				// Sort them (based on when they were received/published)
				return webmentionsForUrl.sort((a, b) => {
					return getPublished(b) - getPublished(a)
				})
			}
			// Otherwise, return an empty Array
			return []
		},
	},
}
```

This attaches an Array containing Webmentions to each page (based on its URL). You can then access this Array of Webmentions with the variable, <samp>webmentions</samp>, within a [Layout](https://www.11ty.dev/docs/layouts/), [Include](https://www.11ty.dev/docs/includes/), or from the page itself:

{% raw %}
```twig
{% for webmention in webmentions %}
    {# Do something with each Webmention #}
{% endfor %}
```
{% endraw %}

These Arrays of Webmentions can even be accessed when building [Collections](https://www.11ty.dev/docs/collections/), allowing you to create a Collection of pages sorted by their number of Webmentions, for example:

```javascript
module.exports = (eleventyConfig) => {
	eleventyConfig.addCollection("popular", (collection) => {
		return collection
			.sort((a, b) => {
				return b.data.webmentions.length - a.data.webmentions.length
			})
	})
}
```

<h2 id="without-directory-data">Without Directory Data</h2>

If you would rather get Webmentions for a given page directly from a Layout/Include/Page itself, you can do so using the Filter, `getWebmentions`:

{% raw %}
```twig
{% set webmentions = ('https://example.com' + page.url) | getWebmentions %}
{% for webmention in webmentions %}
    ...
{% endfor %}
```
{% endraw %}

<h2 id="allowed-types">Get specific types of Webmentions</h2>

Instead of getting all the Webmentions for a given page, you may want to grab only certain types of Webmentions. This is useful if you want to display different types of Webmentions separately, e.g.:

{% raw %}
```twig
{% set bookmarks = webmentions | getWebmentionsByTypes(['bookmark-of']) %}
{% set likes = webmentions | getWebmentionsByTypes(['like-of']) %}
{% set reposts = webmentions | getWebmentionsByTypes(['repost-of']) %}

{% set replies = webmentions | getWebmentionsByTypes(['mention-of', 'in-reply-to']) %}
```
{% endraw %}

<h2 id="all-webmentions">Get all Webmentions at once</h2>

If you need it, the plugin also makes available an Object containing your cached Webmentions organised in key:value pairs, where each key is a full URL on your website and its value is an Array of Webmentions sent to that URL:

{% raw %}
```twig
{% set count = 0 %}
{% for url, array in webmentionsByUrl %}
	{% set count = array.length + count %}
{% endfor %}
<p>This website has received {{ count }} Webmentions!</p>
```
{% endraw %}

<h2 id="webmention-io">Webmention.io</h2>

[Webmention.io](https://webmention.io) is a in-place Webmention receiver solution that you can use by authenticating yourself via [IndieAuth](https://indieauth.com/) (or host it yourself), and, like *so much* other publicly-available IndieWeb software, is built and hosted by [Aaron Parecki](https://aaronparecki.com/).

### Add your token

Get set up on [Webmention.io](https://webmention.io) and add your **API Key** (found on your [settings page](https://webmention.io/settings)) to your project as an environment variable, i.e. in a `.env` file in the root of your project:

```text
WEBMENTION_IO_TOKEN=njJql0lKXnotreal4x3Wmd
```

### Set your feed and key config options

The example below requests the [JF2](https://www.w3.org/TR/jf2/) file format, which I highly recommend using; although, there is a JSON format available from [Webmention.io](https://webmention.io) as well. The [official documentation](https://github.com/aaronpk/webmention.io) has more information on how to use these two formats.

The key difference between the two feed formats is in the *naming* of the keys: the JF2 format holds the array of Webmentions in the `children` key, whereas the JSON format holds them in the `links` key. The JF2 format, however, provides keys and values that more tightly-align with [microformats](https://indieweb.org/microformats), the method I recommend the most for marking up HTML such that it can be consumed and understood by <q>search engines, aggregators, and other tools</q> across the IndieWeb.

```javascript
const pluginWebmentions = require("@chrisburnell/eleventy-cache-webmentions")

module.exports = function(eleventyConfig) {
	eleventyConfig.addPlugin(pluginWebmentions, {
		domain: "https://example.com",
		feed: `https://webmention.io/api/mentions.jf2?domain=example.com&token=${process.env.WEBMENTION_IO_TOKEN}`,
		key: "children",
	})
}
```

If you want to use the JSON format instead, make sure that you replace `mentions.jf2` in the URL with `mentions.json` and change the value of the key from `children` to `links`.

<h3 id="config-generator" class=" [ requires-js ] ">Config Generator</h3>

<form id="config-form" class=" [ grid ] [ requires-js ] " data-layout="50-50" autocomplete="off">
    <fieldset>
        <label for="domain" class=" [ delta ] ">Domain</label>
        <input id="domain" name="domain" type="url" value="https://example.com" class=" [ monospace ] " pattern="\S+\.\S+" required style="inline-size: 100%; line-height: 3;">
    </fieldset>
    <fieldset>
        <label for="type" class=" [ delta ] ">JS Flavour</label>
        <select id="type" name="type" style="inline-size: 100%; padding-block: 0.7rem;" lang="en">
            <option selected>ESM</option>
            <option>CommonJS</option>
        </select>
    </fieldset>
</form>

<pre class="language-javascript  requires-js"><code id="config-output" class="language-javascript"><span class="token keyword">import</span> <span class="token punctuation">{</span> defaults <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"@chrisburnell/eleventy-cache-webmentions"</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> defaults<span class="token punctuation">,</span> <span class="token punctuation">{</span>
	<span class="token literal-property property">domain</span><span class="token operator">:</span> <span class="token string">"https://example.com"</span><span class="token punctuation">,</span>
	<span class="token literal-property property">feed</span><span class="token operator">:</span> <span class="token string">"https://webmention.io/api/mentions.jf2?domain=example.com&amp;token=${process.env.WEBMENTION_IO_TOKEN}"</span><span class="token punctuation">,</span>
	<span class="token literal-property property">key</span><span class="token operator">:</span> <span class="token string">"children"</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre>

## go-jamming

[go-jamming](https://git.brainbaking.com/wgroeneveld/go-jamming) is a self-hosted Webmention sender and receiver, built in Go by [Wouter Groeneveld](https://brainbaking.com) and available with more information on his [personal git instance](https://git.brainbaking.com/wgroeneveld/go-jamming).

### Add your token

Once you‚Äôve set up your *go-jamming* server and you‚Äôve defined your token, you‚Äôll need add it to your project as an environment variable, i.e. in a `.env` file in the root of your project:

```text
GO_JAMMING_TOKEN=njJql0lKXnotreal4x3Wmd
```

### Set your feed and key config options

```javascript
const pluginWebmentions = require("@chrisburnell/eleventy-cache-webmentions")

module.exports = function(eleventyConfig) {
	eleventyConfig.addPlugin(pluginWebmentions, {
		domain: "https://example.com",
		feed: `https://jam.example.com/webmention/example.com/${process.env.GO_JAMMING_TOKEN}`,
		key: "json"
	})
}
```

<script>
const addDefaultScheme = (input) => {
	if (input.match(/^(?!https?:).+\..+/)) {
		return `https://${input.replace(/\/$/, "")}`
	}
	return input.replace(/\/$/, "")
}

const getConfig = (outputElement, domainInput, type = "ESM") => {
	if (!/\S+\.\S+/.test(domainInput)) {
		return
	}

	const importStatement = type === "ESM"
		? `<span class="token keyword">import</span> <span class="token punctuation">{</span> defaults <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"@chrisburnell/eleventy-cache-webmentions"</span>`
		: `<span class="token keyword">const</span> <span class="token punctuation">{</span> defaults <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"@chrisburnell/eleventy-cache-webmentions"</span><span class="token punctuation">)</span>`

	const exportStatement = type === "ESM"
		? `<span class="token keyword">export</span> <span class="token keyword">default</span>`
		: `module<span class="token punctuation">.</span>exports <span class="token operator">=</span>`

	const domain = addDefaultScheme(domainInput)

	const hostname = new URL(domain).hostname

	outputElement.innerHTML = `${importStatement}\n\n${exportStatement} Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> defaults<span class="token punctuation">,</span> <span class="token punctuation">{</span>\n\t<span class="token literal-property property">domain</span><span class="token operator">:</span> <span class="token string">"${domain}"</span><span class="token punctuation">,</span>\n\t<span class="token literal-property property">feed</span><span class="token operator">:</span> <span class="token string">"https://webmention.io/api/mentions.jf2?domain=${hostname}&amp;token=\${process.env.WEBMENTION_IO_TOKEN}"</span><span class="token punctuation">,</span>\n\t<span class="token literal-property property">key</span><span class="token operator">:</span> <span class="token string">"children"</span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span>`
}

const configForm = document.querySelector("#config-form")
const inputDomain = document.querySelector("#domain")
const selectType = document.querySelector("#type")
const output = document.querySelector("#config-output")

configForm.addEventListener("submit", (event) => {
	event.preventDefault()
	getConfig(output, inputDomain.value, selectType.value)
})
inputDomain.addEventListener("change", () => {
	getConfig(output, inputDomain.value, selectType.value)
})
selectType.addEventListener("change", () => {
	getConfig(output, inputDomain.value, selectType.value)
})
</script>
